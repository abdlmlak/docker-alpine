#!/usr/bin/env bash

function usage {
    echo -e "Usage: $(basename "$0") <PID_FILE> <COMMAND>"
    echo -e ""
    echo -e "Execute a daemon process and waits for his end execution."
    echo -e ""
    echo -e "Options:"
    echo -e "  --help\t\t\tdisplay this help and exit"
}

trap 'exit 1' ERR INT TERM

pidfile="$1"
shift
command=$@

function cleanup() {
    trap - ERR SIGINT SIGTERM

    kill $(cat $pidfile)
}

trap 'cleanup; exit 0' ERR SIGINT SIGTERM

$command
sleep 4
while [ -f "$pidfile" ] && kill -0 $(cat "$pidfile") ; do
    sleep 4
done

exit 0
